<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy Bird Mobile</title>
    <style>
        body {
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none; /* Ngăn chặn các thao tác mặc định của trình duyệt như cuộn/zoom */
        }
        canvas {
            display: block;
            background-color: #70c5ce;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Giao diện nút bấm */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none; /* Để không chặn các click vào canvas nếu cần */
        }
        #startBtn {
            padding: 15px 40px;
            font-size: 24px;
            background: #FFD700;
            border: none;
            border-radius: 10px;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
            display: block;
            box-shadow: 0 5px #b89b00;
        }
        #startBtn:active {
            transform: translateY(4px);
            box-shadow: 0 2px #b89b00;
        }
        #pauseBtn {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid #fff;
            border-radius: 50%;
            font-weight: bold;
            display: none;
            z-index: 100;
            pointer-events: auto;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <button id="startBtn">START GAME</button>
</div>
<button id="pauseBtn" onclick="togglePause()">P</button>
<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");

    // 1. CÀI ĐẶT KÍCH THƯỚC (Responsive)
    function setupCanvas() {
        if (window.innerWidth > 768) {
            canvas.width = 530;
            canvas.height = 350;
            pauseBtn.style.display = "none";
        } else {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            pauseBtn.style.display = "block";
            // Yêu cầu xoay ngang nếu là App/Trình duyệt hiện đại
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {
                    console.log("Cần thao tác người dùng để khóa xoay");
                });
            }
        }
    }
    setupCanvas();
    window.addEventListener('resize', setupCanvas);

    // 2. BIẾN GAME
    let isGameStarted = false;
    let isGameOver = false;
    let isPaused = false;
    let score = 0;
    let bestScore = localStorage.getItem("myFlappy_BestScore") || 0;
    let frame = 0;
    let realTime = 0;

    let birdX = 50, birdY = 150, birdSize = 20, velocity = 0;
    let pipes = [], pipeWidth = 50, pipeGap = 100, pipeSpeed = 2;
    let cloudX = 400, bushX = 0;
    let moveSpeed = 4;
    let keys = {};

    // 3. ĐIỀU KHIỂN
    // Trên máy tính
    document.addEventListener("keydown", (e) => {
        keys[e.code] = true;
        if (e.code === "Space") handleMainAction();
    });
    document.addEventListener("keyup", (e) => keys[e.code] = false);

    // Trên điện thoại (Cảm ứng chia vùng)
    canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        if (!isGameStarted || isGameOver) return;

        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const tx = touch.clientX - rect.left;
        const ty = touch.clientY - rect.top;

        // Reset các phím ảo
        keys["ArrowUp"] = ty < canvas.height / 3;
        keys["ArrowDown"] = ty > (canvas.height * 2) / 3;
        keys["ArrowLeft"] = tx < canvas.width / 3;
        keys["ArrowRight"] = tx > (canvas.width * 2) / 3;
    }, {passive: false});

    canvas.addEventListener("touchend", () => {
        keys["ArrowUp"] = false;
        keys["ArrowDown"] = false;
        keys["ArrowLeft"] = false;
        keys["ArrowRight"] = false;
    });

    startBtn.onclick = () => {
        handleMainAction();
        startBtn.style.display = "none";
    };

    function handleMainAction() {
        if (!isGameStarted) {
            isGameStarted = true;
            startBtn.style.display = "none";
        } else if (isGameOver) {
            resetGame(true);
        }
    }

    function togglePause() {
        if (isGameStarted && !isGameOver) isPaused = !isPaused;
    }

    // 4. LOGIC CẬP NHẬT
    function update() {
        if (!isGameStarted || isGameOver || isPaused) return;

        frame++;
        if (frame % 60 === 0) realTime++;

        // Di chuyển nền
        cloudX -= 0.5; if (cloudX < -100) cloudX = canvas.width;
        bushX -= pipeSpeed; if (bushX < -100) bushX = canvas.width;

        // Di chuyển bướm
        velocity = 0;
        if (keys["ArrowUp"]) { birdY -= moveSpeed; velocity = -5; }
        if (keys["ArrowDown"]) { birdY += moveSpeed; velocity = 5; }
        if (keys["ArrowLeft"]) birdX -= moveSpeed;
        if (keys["ArrowRight"]) birdX += moveSpeed;

        // Giới hạn biên
        birdX = Math.max(0, Math.min(canvas.width - birdSize, birdX));
        birdY = Math.max(0, Math.min(canvas.height - birdSize, birdY));

        // Logic ống
        if (pipes.length === 0 || pipes[pipes.length - 1].x < canvas.width - 200) {
            let h = Math.random() * (canvas.height - pipeGap - 40) + 20;
            pipes.push({x: canvas.width, y: h, passed: false});
        }

        pipes.forEach((p, i) => {
            p.x -= pipeSpeed;
            // Va chạm
            if (birdX + birdSize > p.x && birdX < p.x + pipeWidth) {
                if (birdY < p.y || birdY + birdSize > p.y + pipeGap) isGameOver = true;
            }
            // Ăn điểm
            if (!p.passed && p.x + pipeWidth < birdX) {
                score++;
                p.passed = true;
                if (score % 10 === 0) pipeSpeed += 0.2;
            }
        });
        if (pipes.length > 0 && pipes[0].x < -pipeWidth) pipes.shift();

        if (isGameOver) {
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem("myFlappy_BestScore", bestScore);
            }
            startBtn.style.display = "block";
            startBtn.innerText = "RETRY";
        }
    }

    // 5. VẼ
    function draw() {
        ctx.fillStyle = "#70c5ce";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Vẽ mây & bụi cây (giản lược)
        ctx.fillStyle = "white";
        ctx.beginPath(); ctx.arc(cloudX, 50, 20, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#2E8B57";
        ctx.fillRect(bushX, canvas.height - 20, 50, 20);

        // Vẽ Ống
        ctx.fillStyle = "#2ecc71";
        pipes.forEach(p => {
            ctx.fillRect(p.x, 0, pipeWidth, p.y);
            ctx.fillRect(p.x, p.y + pipeGap, pipeWidth, canvas.height);
        });

        // Vẽ Bướm (Đơn giản hóa cho hiệu năng mobile)
        ctx.fillStyle = "#FF1493";
        let wing = Math.sin(frame * 0.2) * 10;
        ctx.fillRect(birdX - 5, birdY + wing, 10, 10); // Cánh trái
        ctx.fillRect(birdX + 15, birdY + wing, 10, 10); // Cánh phải
        ctx.fillStyle = "#4B0082";
        ctx.fillRect(birdX, birdY, birdSize, birdSize); // Thân

        // UI
        ctx.fillStyle = "white";
        ctx.font = "bold 20px Arial";
        ctx.fillText(`Score: ${score}  Time: ${realTime}s`, 20, 30);

        if (isPaused) {
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.textAlign = "center";
            ctx.fillText("PAUSED", canvas.width/2, canvas.height/2);
            ctx.textAlign = "left";
        }

        if (isGameOver) {
            ctx.fillStyle = "rgba(0,0,0,0.7)";
            ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.textAlign = "center";
            ctx.fillStyle = "white";
            ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2 - 20);
            ctx.fillText(`Best: ${bestScore}`, canvas.width/2, canvas.height/2 + 20);
            ctx.textAlign = "left";
        }
    }

    function resetGame(playnow) {
        birdX = 50; birdY = 150; pipes = []; score = 0; 
        frame = 0; realTime = 0; pipeSpeed = 2;
        isGameOver = false; isGameStarted = playnow;
    }

    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }
    gameLoop();
</script>
</body>
</html>
